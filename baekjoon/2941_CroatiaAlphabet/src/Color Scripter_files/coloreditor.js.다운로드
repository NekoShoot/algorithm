/**
 * ColorEditor.js
 * version 0.1.0
 * built in 2016-03-25
 * author prevdev@gmail.com
 *
 *
 * Usage
 *  <div id="my-editor"></div>
 *	<script type="text/javascript">
 *		var me = document.getElementById('my-editor');
 *		var ce = ColorEditor.register(me, 'c');
 *	</script>
 *
 **/
var ColorEditor=function(){var u,p,g,r,m,o,a={},f={},v=!1,b="",l=-1!=navigator.userAgent.indexOf("WebKit"),s=-1!=navigator.userAgent.indexOf("Firefox"),c=!1,C=0;function y(e,t){if(e.getElementsByClassName)return e.getElementsByClassName(t);if(e.querySelectorAll)return e.querySelectorAll("."+t);if(e.getElementsByTagName){for(var n=e.getElementsByTagName("*"),i=[],r=0;r<n.length;r++){-1!=n[r].className.split(" ").indexOf(t)&&i.push(n[r])}return i}}function n(e){m&&(f.codeTextCompose&&f.codeTextCompose(e),v="compositionend"!=e.type)}function i(e){if(m)return f.keyDown&&f.keyDown(e),v=!1,pastedCode=null,s&&(1==e.metaKey&&"v"!=e.key&&(v=!0),13===e.keyCode)?(document.execCommand("insertHTML",!1,"\n"),e.preventDefault(),!1):9===e.keyCode?(document.execCommand("insertHTML",!1,"\t"),e.preventDefault(),!1):"&"==e.key&&m?(document.execCommand("insertHTML",!1,"&amp;"),e.preventDefault(),!1):void k()}function E(e){if(e&&e.clipboardData&&e.clipboardData.setData){var t=window.getSelection().getRangeAt(0).startOffset,n=window.getSelection().getRangeAt(0).endOffset;e.clipboardData.setData("text/plain",b.substring(t,n))}}function x(e){if(f.codePasted&&f.codePasted(e),e&&e.clipboardData&&e.clipboardData.getData&&/text\/plain/.test(e.clipboardData.types)){var t=e.clipboardData.getData("text/plain");t=(t=t.split("\r\n").join("\n")).split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;"),e.preventDefault(),document.execCommand("insertHTML",!1,t)}}function h(e){b=e||(m?(b=g.innerHTML,s&&"<br>"==b.substr(0,4)&&(b="\n"+b),b.replace(/<\/div><div[^>]*>/g,"\n").replace(/<[\s\S]*?>/g,"").split("&lt;").join("<").split("&gt;").join(">").split("&nbsp;").join(" ").split("&amp;").join("&")):g.value)}function T(e,t){if(null!=e&&f.keyUp&&f.keyUp(e),m&&1!=t){if("Range"==window.getSelection().type||v)return;try{s=window.getSelection().getRangeAt(0)}catch(e){return}}if(h(null),k(),m){y(document,"focus-caret").length&&(d=y(document,"focus-caret")[0],d.parentNode.removeChild(d));var n=document.createElement("s");n.id="focus-caret",null!=s&&s.insertNode(n);var i=g.innerHTML.replace(/<\/div><div[^>]*>/g,"\n").replace(/<\/?br[\s\S]*?>/g,"").replace(/<\/?span[\s\S]*?>/g,"").replace(/<\/?font[\s\S]*?>/g,"").replace(/<\/?div[\s\S]*?>/g,"").replace("<i></i>","").split("&lt;").join("<").split("&gt;").join(">").split("&nbsp;").join(" ").split("&amp;").join("&"),r=i.indexOf('<s id="focus-caret"></s>'),o=0;-1==r&&n.remove(),i=u.color(b).split("&nbsp;").join(" ");for(var a=0;a<i.length+1;a++){if(o==r){i=i.substr(0,a)+"<i></i>"+i.substr(a);break}"<"!=i[a]?("&nbsp;"==i.substr(a,6)?a+=5:"&amp;"==i.substr(a,5)?a+=4:"&lt;"!=i.substr(a,4)&&"&gt;"!=i.substr(a,4)||(a+=3),o++):a=i.indexOf(">",a+1)}var l=null;if(f.codeChanging&&(l=f.codeChanging(i,g)),i=l||(-1==i.indexOf("\n")?"<div>"+i+"</div>":"<div>"+i.split("\n").join("</div><div>")+"</div>"),g.blur(),g.innerHTML=i,null!=s&&g.focus(),a=g.getElementsByTagName("i")[0]){var s;(s=document.createRange()).selectNode(a);var c=window.getSelection();c.removeAllRanges(),c.addRange(s),s.deleteContents()}}g.style.color=u.stylePackage.normal,p.style.backgroundColor=u.stylePackage.backgroundColor?u.stylePackage.backgroundColor:"","PRE"!=g.tagName&&(g.style.backgroundColor=p.style.backgroundColor),f.codeChanged&&f.codeChanged(i,g)}function k(){var e=b.split("\n").length;if(e!=r){var t=y(p,"ce-linenumber")[0].getElementsByTagName("ol")[0];t.innerHTML="";for(var n=0;n<e;n++){var i=document.createElement("li");i.innerHTML=n+1,t.appendChild(i)}}return e}return a.init=function(e,t,n){if(!e)throw Error("targetDOM is null");if("undefined"!=typeof ColorScripter){50<++C&&(alert("Error: cannot load colorscripter sdk file"),clearInterval(o),o=null),o&&(clearInterval(o),o=null),(l||s)&&(m=!0),t=t||"text",u=new ColorScripter(t),n&&u.selectStylePackage(n);e.innerHTML='<div class="ColorEditor">\t\t\t<div class="ce-wrap">\t\t\t\t<div class="ce-linenumber">\t\t\t\t\t<ol>\t\t\t\t\t\t<li>1</li>\t\t\t\t\t</ol>\t\t\t\t</div>\t\t\t\t<div class="ce-text-area"></div>\t\t\t</div>\t\t</div>',p=y(e,"ColorEditor")[0],m?a.enableRealTime(!0):a.disableRealTime(!0),a.updateCode("",!0),a.resize()}else if(!c){var i=document.createElement("script"),r=document.getElementsByTagName("script")[0];i.src="http://api.colorscripter.com/code/colorscripter.js",r.parentNode.insertBefore(i,r),c=!0,o=setInterval(function(){a.init(e,t,n)},20)}},a.getColorScripter=function(){return u},a.getEditorDOM=function(){return p},a.getCodeTextDOM=function(){return g},a.getRawCodeText=function(){return b},a.updateCode=function(e,t){e&&(h(e),e=(e=e.split("\r\n").join("\n")).split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;"),m?g.innerHTML=e:g.value=e),T(null,t)},a.resize=function(){g.style.width=p.clientWidth-51-14+"px",g.style.height=p.clientHeight-21+"px",f.resize&&f.resize(g,p)},a.setHook=function(e,t){f[e]=t},a.getRealTimeEnabled=function(){return m},a.enableRealTime=function(e){if(!m||e){m=!0;var t=y(p,"ce-text-area")[0];g&&t.removeChild(g),(g=document.createElement("pre")).setAttribute("class","ce-code-text"),g.setAttribute("contenteditable",!0),g.setAttribute("spellcheck",!1),g.innerHTML="<div></div>",g.addEventListener("compositionstart",n),g.addEventListener("compositionupdate",n),g.addEventListener("compositionend",n),g.addEventListener("keydown",i),g.addEventListener("keyup",T),g.addEventListener("copy",E),g.addEventListener("paste",x),t.appendChild(g),a.updateCode(b),a.resize()}},a.disableRealTime=function(e){if(m||e){m=!1;var t=y(p,"ce-text-area")[0];g&&t.removeChild(g),(g=document.createElement("textarea")).setAttribute("class","ce-code-text"),g.setAttribute("spellcheck",!1),t.appendChild(g),a.updateCode(b),a.resize()}},a};ColorEditor.register=function(e,t,n){if(!e)throw Error("domObj is null");var i=new ColorEditor;return i.init(e,t,n),i};